#!/bin/bash
# t031a5 - Script Principal do Sistema G1
# Uso: ./t031a5 [comando]

# set -e  # Comentado para evitar parada em erros menores

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Banner
show_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘           ğŸ¤– t031a5 G1 System       â•‘"
    echo "â•‘        Sistema OM1 para Unitree      â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# Ajuda
show_help() {
    echo -e "${BLUE}ğŸ“‹ COMANDOS DISPONÃVEIS:${NC}"
    echo
    echo -e "  ${GREEN}./t031a5 start${NC}      - Iniciar sistema (modo interativo)"
    echo -e "  ${GREEN}./t031a5 deploy${NC}     - Deploy completo (primeira vez)"
    echo -e "  ${GREEN}./t031a5 setup${NC}      - Setup ambiente e dependÃªncias"
    echo -e "  ${GREEN}./t031a5 status${NC}     - Status do sistema"
    echo -e "  ${GREEN}./t031a5 logs${NC}       - Ver logs em tempo real"
    echo -e "  ${GREEN}./t031a5 test${NC}       - Executar testes"
    echo -e "  ${GREEN}./t031a5 clean${NC}      - Limpar logs e temporÃ¡rios"
    echo -e "  ${GREEN}./t031a5 help${NC}       - Esta ajuda"
    echo
    echo -e "${PURPLE}ğŸ¯ MODOS RÃPIDOS:${NC}"
    echo -e "  ${GREEN}./t031a5 prod${NC}       - ProduÃ§Ã£o (G1 real)"
    echo -e "  ${GREEN}./t031a5 logitech${NC}   - ğŸ“· CÃ¢mera Logitech USB"
    echo -e "  ${GREEN}./t031a5 mock${NC}       - Desenvolvimento (mock)"
    echo -e "  ${GREEN}./t031a5 websim${NC}     - Apenas WebSim"
    echo -e "  ${GREEN}./t031a5 talk${NC}       - Modo conversaÃ§Ã£o"
    echo -e "  ${GREEN}./t031a5 native${NC}     - Conectores nativos"
    echo -e "  ${GREEN}./t031a5 test${NC}       - Teste no robÃ´ G1"
    echo -e "  ${GREEN}./t031a5 elevenlabs${NC} - ğŸ¤ ElevenLabs TTS"
    echo -e "  ${GREEN}./t031a5 api${NC}        - Gerenciar APIs"
    echo
    echo -e "${CYAN}ğŸ’¡ Exemplos:${NC}"
    echo -e "  ./t031a5 start     # Modo interativo"
    echo -e "  ./t031a5 prod      # Direto para produÃ§Ã£o"
    echo -e "  ./t031a5 status    # Ver status"
}

# Verificar se estÃ¡ na pasta correta
check_directory() {
    if [ ! -f "pyproject.toml" ]; then
        echo -e "${RED}âŒ Execute este script na pasta raiz do projeto t031a5${NC}"
        exit 1
    fi
}

# Ativar ambiente virtual
activate_venv() {
    if [ ! -d "venv" ]; then
        echo -e "${YELLOW}ğŸ“¦ Criando ambiente virtual...${NC}"
        python3 -m venv venv
    fi
    
    echo -e "${BLUE}ğŸ”§ Ativando ambiente virtual...${NC}"
    
    # Detectar shell e ativar apropriadamente
    if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "win32" ]]; then
        # Windows/PowerShell
        if [ -f "venv/Scripts/activate" ]; then
            source venv/Scripts/activate
        else
            echo -e "${YELLOW}âš ï¸  Usando Python direto da venv${NC}"
            export PATH="venv/Scripts:$PATH"
        fi
    else
        # Unix/Linux/macOS
        source venv/bin/activate
    fi
    
    # Verificar se projeto estÃ¡ instalado
    if ! python -c "import t031a5" 2>/dev/null; then
        echo -e "${YELLOW}ğŸ“¦ Instalando projeto...${NC}"
        pip install -e . -q
    fi
}

# Comandos
cmd_start() {
    show_banner
    activate_venv
    
    echo -e "${BLUE}ğŸ¯ Selecione o modo:${NC}"
    echo "1) ğŸ¯ ProduÃ§Ã£o (G1 real)"
    echo "2) ğŸ“· CÃ¢mera Logitech USB"
    echo "3) ğŸ§ª Desenvolvimento (Mock)" 
    echo "4) ğŸŒ WebSim apenas"
    echo "5) ğŸ’¬ ConversaÃ§Ã£o avanÃ§ada"
    echo "6) ğŸ”Œ Conectores Nativos (otimizaÃ§Ã£o)"
    echo
    read -p "Escolha (1-6): " choice
    
    case $choice in
        1) run_config "config/g1_production.json5" "ğŸ¯ PRODUÃ‡ÃƒO" ;;
        2) run_config "config/g1_logitech.json5" "ğŸ“· LOGITECH" ;;
        3) run_config "config/g1_mock.json5" "ğŸ§ª MOCK" ;;
        4) run_websim_only ;;
        5) run_config "config/g1_conversation.json5" "ğŸ’¬ CONVERSAÃ‡ÃƒO" ;;
        6) run_config "config/g1_native_connectors.json5" "ğŸ”Œ CONECTORES NATIVOS" ;;
        *) echo -e "${RED}OpÃ§Ã£o invÃ¡lida${NC}"; exit 1 ;;
    esac
}

cmd_deploy() {
    show_banner
    echo -e "${BLUE}ğŸš€ Executando deploy completo...${NC}"
    ./deploy_g1.sh
}

cmd_setup() {
    show_banner
    activate_venv
    echo -e "${GREEN}âœ… Setup concluÃ­do!${NC}"
}

run_config() {
    local config=$1
    local mode=$2
    echo -e "${GREEN}ğŸš€ Iniciando ${mode}...${NC}"
    python -m t031a5.cli run --config "$config"
}

run_websim_only() {
    echo -e "${CYAN}ğŸŒ Iniciando WebSim...${NC}"
    cat > /tmp/websim_only.json5 << EOF
{
  "name": "WebSim Only",
  "hertz": 2,
  "development": {"websim_enabled": true},
  "agent_inputs": {}, "agent_actions": {},
  "fuser": {"type": "priority", "config": {}},
  "llm": {"provider": "mock"},
  "g1_controller": {"enabled": false},
  "websim": {"enabled": true, "host": "0.0.0.0", "port": 8080},
  "logging": {"level": "INFO"}
}
EOF
    python -m t031a5.cli run --config /tmp/websim_only.json5
    rm /tmp/websim_only.json5
}

cmd_status() {
    activate_venv
    python -m t031a5.cli status
}

cmd_logs() {
    if [ -f "logs/g1_production.log" ]; then
        tail -f logs/g1_production.log
    elif [ -f "logs/g1_mock.log" ]; then
        tail -f logs/g1_mock.log
    else
        echo -e "${YELLOW}âš ï¸  Nenhum log encontrado${NC}"
    fi
}

cmd_test() {
    activate_venv
    echo -e "${BLUE}ğŸ§ª Executando testes...${NC}"
    python tests/run_test.py test_system.py
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ Limpando arquivos temporÃ¡rios...${NC}"
    rm -rf logs/*.log temp/ .pytest_cache/ *.tmp 2>/dev/null || true
    echo -e "${GREEN}âœ… Limpeza concluÃ­da${NC}"
}

cmd_api() {
    echo -e "${BLUE}ğŸ” Iniciando comando API...${NC}"
    # Executar diretamente com todos os argumentos exceto o primeiro
    venv/bin/python -m t031a5.cli_api "${@:2}"
}

# Main
main() {
    check_directory
    
    echo -e "${BLUE}ğŸ” Comando recebido: '$1'${NC}"
    
    case "${1:-help}" in
        start)   cmd_start ;;
        deploy)  cmd_deploy ;;
        setup)   cmd_setup ;;
        status)  cmd_status ;;
        logs)    cmd_logs ;;
        test)    cmd_test ;;
        clean)   cmd_clean ;;
        api)     echo -e "${BLUE}ğŸ” Executando cmd_api${NC}" && cmd_api ;;
                        prod)    activate_venv && run_config "config/g1_production.json5" "ğŸ¯ PRODUÃ‡ÃƒO" ;;
                logitech) activate_venv && run_config "config/g1_logitech.json5" "ğŸ“· LOGITECH" ;;
                mock)    activate_venv && run_config "config/g1_mock.json5" "ğŸ§ª MOCK" ;;
                websim)  activate_venv && run_websim_only ;;
                talk)    activate_venv && run_config "config/g1_conversation.json5" "ğŸ’¬ CONVERSAÃ‡ÃƒO" ;;
                native)  activate_venv && run_config "config/g1_native_connectors.json5" "ğŸ”Œ CONECTORES NATIVOS" ;;
                test)    activate_venv && run_config "config/g1_test_robot.json5" "ğŸ¤– TESTE NO ROBÃ”" ;;
                elevenlabs) activate_venv && run_config "config/g1_elevenlabs.json5" "ğŸ¤ ELEVENLABS TTS" ;;
        help|*)  show_help ;;
    esac
}

main "$@"
